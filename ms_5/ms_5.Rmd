---
title: "Initial Visualization"
author: "Matej Cerman"
date: "3/18/2020"
output: html_document
---

My final project will focus on finding regional patterns in the ratings of Slovak primary and secondary schools, mainly the dependence of schools' performances on the socioeconomic situation of their counties. The plot below is the first attempt at viewing these relationships, as it looks at the overall rating of primary schools in all counties (provided by INEKO, a Slovak NGO) versus the average monthly salary in these counties (collected by the Slovak government).

You can find my GitHub repo [here](https://github.com/matejcerman/gov1005_final_project).

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = F)

# load packages
library(tidyverse)
library(janitor)
library(readxl)
```

```{r load_data, message = FALSE}

# This function allows me to read in csv files compiled
# by INEKO, the think-tank whose data I'm using. It uses
# international encoding that recognizes special signs in
# the Slovak alphabet (like á, č, ä, ô, etc.) and uses a
# decimal comma instead of a decimal point

read_slovak_csv <- function(path, ...) {
  read_delim(file = path, 
             delim = ";", 
             escape_double = FALSE, 
             locale = locale(decimal_mark = ",", encoding = "WINDOWS-1252"), 
             trim_ws = TRUE,
             ...) %>%
    clean_names()
}

# Loading 4 datasets obtained from INEKO 

raw_school_ratings <- read_slovak_csv("../raw_data/INEKO/recent/celkove_hodnotenie_2018-19.csv")

# Please note that all of these produce messages about R
# parsing column types based on the data. For the most part,
# R guesses correctly, but I'll deal with the problematic columns
# later, should they be needed for my analysis.

# Load governmental data

raw_wages <- read_slovak_csv("../raw_data/Government/wages.csv",
                         skip = 3,
                         col_names = c("county", "type", "avg_wage")) %>%
  clean_names()

raw_unemployment <- read_xlsx("../raw_data/Government/unemployment.xlsx",
                          sheet = 3,
                          skip = 7) %>%
  clean_names()

```

```{r clean_data}

# Only keep columns that provide useful information and translate column names
# to English in order to make this legible to all readers

school_ratings <- raw_school_ratings %>%
  select(-druh_skoly, -nazov, -ulica) %>%
  rename(region = kraj,
         county = okres,
         school_board = zriadovatel,
         language = jazyk,
         type = typ_skoly,
         town = obec,
         zip_code = psc,
         overall_rating = celkove_hodnotenie,
         math = matematika,
         first_language = vyucovaci_jazyk,
         foreign_languages = cudzie_jazyky,
         special_achievements = mimoriadne_vysledky,
         alumni_unemployment = nezamestnanost_absolventov,
         inspection_results = vysledky_inspekcie,
         competition_results = ucasti_na_sutaziach,
         college_admissions = prijimanie_na_vs,
         teachers = pedagogicky_zbor,
         financial_resources = financne_zdroje) %>%
  
  # Change categorical columns to factors for easier plotting and manipulation
  
  mutate(region = as.factor(region),
         county = as.factor(county),
         school_board = as.factor(school_board),
         language = as.factor(language),
         type = as.factor(type),
         town = as.factor(town))

# This piece of code keeps only informative columns and also removes the word
# "Okres" translating to "County" from county names. This makes it possible to
# join the datasets by county

wages <- raw_wages %>%
  mutate(county = str_remove(county,
                             pattern = "Okres ")) %>%
  select(-type) %>%
  mutate(county = as.factor(county))

# Keep only useful columns from the unemployment data and translate them to
# English

unemployment <- raw_unemployment %>%
  rename(county = uzemie,
         unemployment_rate = miera_evidovanej_nezamestnanosti_v_percent) %>%
  select(county, unemployment_rate)
```

```{r scatterplot}

# Join the tibble of school rankings with the data about the average salary by
# the "county" variable

ratings_with_wages <- school_ratings %>%
  inner_join(wages, by = "county") %>%
  rename(avg_wage_county = avg_wage)

# Filter for only primary schools ("Základná škola" in Slovak) and find the
# average school rating (computed by the NGO that aggregated the data) in each
# county

regional_summary <- ratings_with_wages %>%
  filter(type == "Základná škola") %>%
  group_by(region, county) %>%
  summarize(avg_score = mean(overall_rating, na.rm = TRUE),
            avg_wage = mean(avg_wage_county))

# Reorder the names of regions by the average school rating within those regions
# for prettier and clearer plots

regional_summary$region <- fct_reorder(regional_summary$region,
                                       regional_summary$avg_score,
                                       .desc = TRUE,
                                       na.rm = TRUE)

# Make a clearly labeled scatterplot of the average primary school rating within
# a county versus the average monthly salary, with the color of points
# corresponding to the administrative region

regional_summary %>%
  ggplot(aes(x = avg_wage, y = avg_score, color = region)) +
  geom_point(alpha = 0.75) +
  stat_smooth(aes(x = avg_wage, y = avg_score), inherit.aes = FALSE, 
              method = "lm", geom = "line",
              color = "black", alpha = 0.7) +
  labs(title = "Average Rating of Primary Schools Versus Average Monthly Salary",
       subtitle = "In 79 Slovak counties grouped into 8 administrative regions (in 2018)",
       x = "Average Gross Monthly Salary (Eur)",
       y = "Average Score of Primary Schools \n on a scale from 0 to 10",
       color = "Region",
       caption = "Sources: INEKO, data.gov.sk") +
  theme_classic()
```



